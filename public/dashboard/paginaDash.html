<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <link rel="stylesheet" href="Dash.css">

    <!-- scripts do Chart.js - 2022-1 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons+Sharp">
</head>

<body onload="atualizarFeed()">
    <div class="container">
        <div class="sidebar">
            <div class="logo">
                <img src="imgs/logo-tech-health-2.png">
            </div>
            <a href="index.html" >
                <span class="material-icons-sharp">home</span>
                <h3>Início</h3>
            </a>
            <a href="paginaDash.html" class="active">
                <span class="material-icons-sharp">grid_view</span>
                <h3>Dashboard</h3>
            </a>
            <a href="perfil.html">
                <span class="material-icons-sharp">person_outline</span>
                <h3>Perfil</h3>
            </a>
            <a href="historico.html">
                <span class="material-icons-sharp">report_gmailerrorred</span>
                <h3>Histórico</h3>
            </a>
            <a href="../login.html">
                <span class="material-icons-sharp">logout</span>
                <h3>Logout</h3>
            </a>
        </div>
        <div class="content">
            <div class="top-menu">
                <button id="menu-btn">
                    <span class="material-icons-sharp">menu</span>
                </button>
                <div class="theme-toggler">
                    <span class="material-icons-sharp active">light_mode</span>
                    <span class="material-icons-sharp">dark_mode</span>
                </div>
                <div class="profile">
                    <div class="info">
                        <p>Olá, <b  id="userName">Dillan</b></p>
                        <small class="text-muted">Admin</small>
                    </div>
                    <!-- <div class="profile-photo">
                        <img src="imgs/profile-1.jpg" alt="">
                    </div> -->
                </div>
            </div>
            <div class="view">
                <div class="painel">
                    <button class="btn"  onclick="obterDadosGrafico(1)">Maq. 01</button>
                    <button class="btn"  onclick="obterDadosGrafico(2)">Maq. 02</button>
                    <button class="btn"  onclick="obterDadosGrafico(3)">Maq. 03</button>
                    <button class="btn"  onclick="obterDadosGrafico(4)">Maq. 04</button>
                </div>
                <div class="painel2">
                    <div class="subdiv">
                        <div class="card">
                            <canvas id="myChart1"></canvas>
                        </div>
                        <div class="card">
                            <canvas id="myChart2"></canvas>
                        </div>
                    </div>
                    <br><br>
                    <div class="subdiv">
                        <div class="card">
                            <canvas id="myChart3"></canvas>
                        </div>
                        <div class="card">
                            <canvas id="myChart4"></canvas>
                        </div>
                    </div>
                    <br><br><br>
    
                </div>
            </div>
            

        </div>
    </div>

    <script src="../js/dashboard.js"></script>
    
</body>

</html>

<!-- <script>
    const labels = [
        '7h',
        '8h',
        '9h',
        '10h',
        '11h',
        '12h',
    ];

    const data = {
        labels: labels,
        datasets: [{
            label: 'CPU',
            backgroundColor: '#23A8C6',
            borderColor: '#23A8C6',
            data: [20, 30, 35, 30, 30, 2],
        }]
    };

    const config = {
        type: 'line',
        data: data,
        options: {}
    };

    // ___________________________________Chart 2_____________________________________
    const labels2 = [
        '7h',
        '8h',
        '9h',
        '10h',
        '11h',
        '12h',
    ];

    const data2 = {
        labels: labels2,
        datasets: [{
            label: 'Processador',
            backgroundColor: '#23A8C6',
            borderColor: '#23A8C6',
            data: [30, 42, 74, 42, 24, 42],
        }]
    };

    const config2 = {
        type: 'line',
        data: data2,
        options: {}
    };

    // ___________________________________Chart 3_____________________________________
    const labels3 = [
        '7h',
        '8h',
        '9h',
        '10h',
        '11h',
        '12h',
    ];

    const data3 = {
        labels: labels3,
        datasets: [{
            label: 'Disco',
            backgroundColor: '#23A8C6',
            borderColor: '#23A8C6',
            data: [30, 50, 35, 20, 0, 2],
        }]
    };

    const config3 = {
        type: 'line',
        data: data3,
        options: {}
    };
    
    // ___________________________________Chart 4_____________________________________
    const labels4 = [
        '7h',
        '8h',
        '9h',
        '10h',
        '11h',
        '12h',
    ];

    const data4 = {
        labels: labels4,
        datasets: [{
            label: 'Memória',
            backgroundColor: '#23A8C6',
            borderColor: '#23A8C6',
            data: [50, 20, 20, 20, 20, 2],
        }]
    };

    const config4 = {
        type: 'line',
        data: data4,
        options: {}
    };
</script> -->

<!-- <script>
    const myChart = new Chart(
        document.getElementById('myChart1'),
        config
    );

    const myChart2 = new Chart(
        document.getElementById('myChart2'),
        config2
    );

    const myChart3 = new Chart(
        document.getElementById('myChart3'),
        config3
    );

    const myChart4 = new Chart(
        document.getElementById('myChart4'),
        config4
    );
</script> -->

<!-- <script>
    function m1() {
        data.datasets[0].data = [20, 30, 35, 30, 30, 2];
        myChart.update();

        data2.datasets[0].data = [30, 42, 74, 42, 24, 42];
        myChart2.update();

        data3.datasets[0].data = [30, 50, 35, 20, 0, 2];
        myChart3.update();

        data4.datasets[0].data = [50, 20, 20, 20, 20, 2];
        myChart4.update();


    }

    function m2() {
        data.datasets[0].data = [50, 60, 35, 20, 20, 2];
        myChart.update();

        data2.datasets[0].data = [80, 52, 72, 12, 2, 2];
        myChart2.update();

        data3.datasets[0].data = [10, 20, 30, 2, 50, 2];
        myChart3.update();

        data4.datasets[0].data = [100, 2, 2, 2, 2, 2];
        myChart4.update();
    }

    function m3() {
        data.datasets[0].data = [90, 0, 90, 90, 100, 50];
        myChart.update();

        data2.datasets[0].data = [80, 20, 20, 13, 20, 12];
        myChart2.update();

        data3.datasets[0].data = [100, 25, 35, 5, 50, 29];
        myChart3.update();

        data4.datasets[0].data = [0, 0, 0, 2, 2, 2];
        myChart4.update();
    }

    function m4() {
        data.datasets[0].data = [0, 60, 0, 0, 20, 0];
        myChart.update();

        data2.datasets[0].data = [10, 10, 72, 12, 10, 2];
        myChart2.update();

        data3.datasets[0].data = [10, 20, 30, 2, 50, 2];
        myChart3.update();

        data4.datasets[0].data = [100, 2, 2, 2, 2, 2];
        myChart4.update();
    }
</script> -->

<script> 
    let proximaAtualizacao;
        
    window.onload = obterDadosGrafico(1);

    // verificar_autenticacao();

    // function alterarTitulo(idMaquina) {
    //     var tituloMaquina = document.getElementById("tituloMaquina")
    //     tituloMaquina.innerHTML = "Últimas medidas de Temperatura e Umidade do <span style='color: #e6005a'>Aquário " + idMaquina + "</span>"
    // }

    // O gráfico é construído com três funções:
    // 1. obterDadosGrafico -> Traz dados do Banco de Dados para montar o gráfico da primeira vez
    // 2. plotarGrafico -> Monta o gráfico com os dados trazidos e exibe em tela
    // 3. atualizarGrafico -> Atualiza o gráfico, trazendo novamente dados do Banco

    // Esta função *obterDadosGrafico* busca os últimos dados inseridos em tabela de medidas.
    // para, quando carregar o gráfico da primeira vez, já trazer com vários dados.
    // A função *obterDadosGrafico* também invoca a função *plotarGrafico*

    //     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
    //     Para ajustar o "select", ajuste o comando sql em src/models
    function obterDadosGrafico(idMaquina) {
        // alterarTitulo(idMaquina)

        if (proximaAtualizacao != undefined) {
            clearTimeout(proximaAtualizacao);
        }

        fetch(`/medidas/ultimas/${idMaquina}`, { cache: 'no-store' }).then(function (response){
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    resposta.reverse();

                    plotarGrafico(resposta, idMaquina);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    // Esta função *plotarGrafico* usa os dados capturados na função anterior para criar o gráfico
    // Configura o gráfico (cores, tipo, etc), materializa-o na página e, 
    // A função *plotarGrafico* também invoca a função *atualizarGrafico*
    function plotarGrafico(resposta, idMaquina) {
        console.log('iniciando plotagem do gráfico...');

        // Criando estrutura para plotar gráfico - labels
        let labels = [];
        
        // Criando estrutura para plotar gráfico - dados
  
    };
        let dados = {
            // labels: labels,
            datasets: [{
                data: [],
                fill: false,
                label: 'CPU',
                backgroundColor: '#23A8C6',
                borderColor: '#23A8C6',
                tension: 0.1
            }]
        };
        
        console.log('----------------------------------------------')
        console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
        console.log(resposta)
        
        // Inserindo valores recebidos em estrutura para plotar o gráfico
        for (i = 0; i < resposta.length; i++) {
            var registro = resposta[i];
            labels.push(registro.momento_grafico);
            dados.datasets[0].data.push(registro.percent_Uso_Cpu_Processo);
            
        }
        
        console.log('----------------------------------------------')
        console.log('O gráfico será plotado com os respectivos valores:')
        console.log('Labels:')
        console.log(labels)
        console.log('Dados:')
        console.log(dados.datasets)
        console.log('----------------------------------------------')
        
        // Criando estrutura para plotar gráfico - config
        const config = {
            type: 'line',
            data: dados,
        };

        // Adicionando gráfico criado em div na tela
        let myChart = new Chart(
            document.getElementById('myChart1'),
            config
        );

        setTimeout(() => atualizarGrafico(idAquario, dados, myChart), 2000);
    


    // Esta função *atualizarGrafico* atualiza o gráfico que foi renderizado na página,
    // buscando a última medida inserida em tabela contendo as capturas, 

    //     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
    //     Para ajustar o "select", ajuste o comando sql em src/models
    function atualizarGrafico(idMaquina, dados, myChart) {

        fetch(`/medidas/tempo-real/${idMaquina}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (novoRegistro) {

                    console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
                    console.log(`Dados atuais do gráfico:`);
                    console.log(dados);

                    document.getElementById("avisoCaptura").innerHTML = ""

                    if (novoRegistro[0].momento_grafico == dados.labels[dados.labels.length - 1]) {
                        console.log("---------------------------------------------------------------")
                        console.log("Como não há dados novos para captura, o gráfico não atualizará.")
                        document.getElementById("avisoCaptura").innerHTML = "<i class='fa-solid fa-triangle-exclamation'></i> Foi trazido o dado mais atual capturado pelo sensor. <br> Como não há dados novos a exibir, o gráfico não atualizará."
                        console.log("Horário do novo dado capturado:")
                        console.log(novoRegistro[0].momento_grafico)
                        console.log("Horário do último dado capturado:")
                        console.log(dados.labels[dados.labels.length - 1])
                        console.log("---------------------------------------------------------------")
                    } else {
                        // tirando e colocando valores no gráfico
                        dados.labels.shift(); // apagar o primeiro
                        dados.labels.push(novoRegistro[0].momento_grafico); // incluir um novo momento

                        dados.datasets[0].data.shift();  // apagar o primeiro de umidade
                        dados.datasets[0].data.push(novoRegistro[0].umidade); // incluir uma nova medida de umidade

                        dados.datasets[1].data.shift();  // apagar o primeiro de temperatura
                        dados.datasets[1].data.push(novoRegistro[0].temperatura); // incluir uma nova medida de temperatura

                        myChart.update();
                    }

                    // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                    proximaAtualizacao = setTimeout(() => atualizarGrafico(idMaquina, dados, myChart), 2000);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
                // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                proximaAtualizacao = setTimeout(() => atualizarGrafico(idMaquina, dados, myChart), 2000);
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });

    }
</script>
